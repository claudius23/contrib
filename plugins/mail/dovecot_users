#!@@PERL@@
# -*- perl -*-

=head1 NAME

dovecot - plugin to monitor the dovecot mail server
currently connected users

=head1 APPLICABLE SYSTEMS

Hosts running dovecot

=head1 CONFIGURATION

Configuration parameters for @@CONFDIR@@/dovecot,
if you need to override the defaults below:

 [dovecot]
  env.doveadm - Where is doveadm

=head2 DEFAULT CONFIGURATION

 [dovecot]
  env.doveadm /usr/bin/doveadm

=head1 AUTHOR

Claudius Herder

=head1 LICENSE

GPLv2

=head1 MAGIC MARKERS

=begin comment

These magic markers are used by munin-node-configure when installing
munin-node.

=end comment

 #%# family=auto
 #%# capabilities=autoconf

=cut

use strict;
use warnings;

use Munin::Plugin;

my $DOVEADM = (defined($ENV{'doveadm'}) ? $ENV{'doveadm'} : '/usr/local/bin/doveadm');

if ( defined($ARGV[0]) and $ARGV[0] eq "autoconf" )
{
        print "no (could not find logdir)\n";

    exit 0;
}

my %users = (
    imap => '0',
    pop3 => '0',
    sieve => '0'
);

if ( $ARGV[0] and $ARGV[0] eq "config" )
{
    print "graph_title dovecot connected users\n";
    print "graph_vlabel users\n";
    print "graph_category dovecot\n";
    print "graph_scale no\n";
    print "graph_args --base 1000 -l 0\n";
    print "graph_period minute\n";
    print "graph_total total\n";

    foreach my $i (sort keys %users)
    {
        print "$i.label $i\n";
        print "$i.type GAUGE\n";
        print "$i.info Number of $i users curently connected\n";
    }
    exit 0;
}

foreach my $line (split(/\n/, `$DOVEADM -f flow who -1` ))
{
    my (undef, $proto, undef, undef ) = (split(/ /,$line));

    if($line =~ /imap/)
    {
        $users{imap}++;
    }
    elsif($line =~ /pop/)
    {
        $users{pop3}++;
    }
    elsif($line =~ /sieve/)
    {
        $users{sieve}++;
    }
}

foreach my $i (sort keys %users)
{
    print "$i.value $users{$i}\n";
}

# vim:syntax=perl
